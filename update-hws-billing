#!/bin/bash
# ══════════════════════════════════════════════════
# HWS Billing — Deploy Script
# Place in /usr/local/bin/update-hws-billing
# Run from repo root: update-hws-billing
# ══════════════════════════════════════════════════

set -e

REPO_DIR="/home/hexawebsystems/billing.hexawebsystems.com"
cd "$REPO_DIR"

echo "═══════════════════════════════════════"
echo " HWS Billing — Deploying..."
echo "═══════════════════════════════════════"

# Pull latest code
echo ""
echo ">> git pull"
git pull

# Install/update dependencies
echo ""
echo ">> composer install"
composer install --no-dev --optimize-autoloader --no-interaction

# Clear all caches
echo ""
echo ">> Clearing caches"
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear

# Run migrations
echo ""
echo ">> Running migrations"
php artisan migrate --force

# Rebuild caches
echo ""
echo ">> Rebuilding caches"
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Dump autoload
echo ""
echo ">> composer dump-autoload"
composer dump-autoload --optimize

# Show version
echo ""
echo "═══════════════════════════════════════"
VERSION=$(php artisan tinker --execute="echo config('hws.version');" 2>/dev/null || echo "unknown")
echo " Deployed: v${VERSION}"
echo "═══════════════════════════════════════"
echo ""
echo "Done."
